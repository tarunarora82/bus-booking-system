<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Booking System - Fixed</title>
    
    <!-- Security Headers - Only allow local resources -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'none';">
    
    <!-- Styles -->
    <link rel="stylesheet" href="/assets/css/styles.css">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-spinner"></div>
        <h2>Loading Bus Booking System...</h2>
        <p>Offline Mode - No network required</p>
    </div>

    <!-- Main Application -->
    <div id="app" class="app hidden">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <h1>
                    <span class="bus-icon">ðŸšŒ</span>
                    Bus Booking System
                    <span class="offline-indicator">ðŸ“´ Offline</span>
                </h1>
                <div class="header-info">
                    <span id="current-date"></span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Worker ID Input Section -->
            <section id="worker-id-section" class="section">
                <div class="card">
                    <h2>Enter Your Worker ID</h2>
                    <div class="input-group">
                        <label for="worker-id-input">Worker ID *</label>
                        <input 
                            type="text" 
                            id="worker-id-input" 
                            placeholder="Enter your 7-digit Worker ID"
                            maxlength="10"
                            autocomplete="off"
                        >
                        <div class="input-help">
                            Enter your company-assigned Worker ID (7-10 digits)
                        </div>
                    </div>
                    <div class="button-group">
                        <button id="check-status-btn" class="btn btn-primary">
                            Check Status
                        </button>
                    </div>
                </div>
            </section>

            <!-- Schedules Section -->
            <section id="schedules-section" class="section hidden">
                <div class="section-header">
                    <h2>Available Bus Schedules</h2>
                    <p>Select a schedule to book your slot for today</p>
                </div>
                <div id="schedules-container" class="schedules-grid">
                    <!-- Schedules will be loaded here -->
                </div>
            </section>

            <!-- Status Section -->
            <section id="status-section" class="section hidden">
                <div class="card">
                    <h2>Your Booking Status</h2>
                    <div id="status-container">
                        <!-- Status will be loaded here -->
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <p>&copy; 2024 Bus Booking System. All rights reserved. | Offline Mode</p>
        </footer>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Inline Scripts to avoid loading issues -->
    <script>
        // Embedded configuration
        const APP_CONFIG = {
            API_BASE_URL: '/api',
            API_TIMEOUT: 10000,
            TOKEN_KEY: 'bus_booking_token',
            USER_DATA_KEY: 'bus_booking_user',
            WORKER_ID_MIN_LENGTH: 7,
            WORKER_ID_MAX_LENGTH: 10,
            TOAST_DURATION: 5000,
            DEBUG: true,
            ERROR_CODES: {
                NETWORK_ERROR: 'NETWORK_ERROR',
                SERVER_ERROR: 'SERVER_ERROR',
                VALIDATION_ERROR: 'VALIDATION_ERROR'
            }
        };

        // Embedded utilities
        const Utils = {
            storage: {
                get: (key) => localStorage.getItem(key),
                set: (key, value) => localStorage.setItem(key, value),
                remove: (key) => localStorage.removeItem(key)
            },
            getElementById: (id) => document.getElementById(id),
            error: {
                handle: (error) => console.error('Error:', error)
            }
        };

        // Embedded API service - completely offline
        class APIService {
            constructor() {
                this.localData = {
                    schedules: [
                        {
                            id: 1,
                            name: 'Morning Shift - Bus A',
                            departure_time: '08:00',
                            arrival_time: '18:00',
                            capacity: 45,
                            available_seats: 32,
                            route: 'City Center to Industrial Park',
                            type: 'morning',
                            schedule_type: 'morning'
                        },
                        {
                            id: 2,
                            name: 'Evening Shift - Bus B',
                            departure_time: '18:30',
                            arrival_time: '04:30',
                            capacity: 45,
                            available_seats: 28,
                            route: 'Industrial Park to City Center',
                            type: 'evening',
                            schedule_type: 'evening'
                        },
                        {
                            id: 3,
                            name: 'Night Shift - Bus C',
                            departure_time: '22:00',
                            arrival_time: '08:00',
                            capacity: 40,
                            available_seats: 15,
                            route: 'City Center to Industrial Park',
                            type: 'night',
                            schedule_type: 'night'
                        }
                    ],
                    bookings: {}
                };
            }

            async getAvailableSchedules(date = null) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve({
                            success: true,
                            data: {
                                schedules: this.localData.schedules
                            },
                            message: 'Schedules retrieved successfully (offline mode)'
                        });
                    }, 200);
                });
            }

            async createBooking(workerId, scheduleId, date) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const bookingId = 'BK' + Date.now();
                        const key = `${workerId}_${scheduleId}_${date}`;
                        this.localData.bookings[key] = {
                            booking_id: bookingId,
                            worker_id: workerId,
                            schedule_id: scheduleId,
                            date: date,
                            status: 'confirmed',
                            created_at: new Date().toISOString()
                        };
                        
                        // Reduce available seats
                        const schedule = this.localData.schedules.find(s => s.id === parseInt(scheduleId));
                        if (schedule && schedule.available_seats > 0) {
                            schedule.available_seats--;
                        }
                        
                        resolve({
                            success: true,
                            data: {
                                booking_id: bookingId,
                                status: 'confirmed'
                            },
                            message: 'Booking created successfully (offline mode)'
                        });
                    }, 300);
                });
            }

            async getBookingStatus(workerId, scheduleId, date) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const key = `${workerId}_${scheduleId}_${date}`;
                        const booking = this.localData.bookings[key];
                        
                        resolve({
                            success: true,
                            data: {
                                booking: booking || null,
                                has_booking: !!booking
                            },
                            message: 'Booking status retrieved successfully (offline mode)'
                        });
                    }, 100);
                });
            }
        }

        // Initialize API
        const API = new APIService();
        console.log('API service initialized:', API);

        // Simple application logic
        class BusBookingApp {
            constructor() {
                this.currentWorkerId = null;
                this.schedules = [];
                this.init();
            }

            init() {
                this.bindEvents();
                this.hideLoadingScreen();
                this.updateDate();
            }

            bindEvents() {
                const checkBtn = document.getElementById('check-status-btn');
                if (checkBtn) {
                    checkBtn.addEventListener('click', () => this.handleCheckStatus());
                }

                const workerInput = document.getElementById('worker-id-input');
                if (workerInput) {
                    workerInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.handleCheckStatus();
                        }
                    });
                }
            }

            updateDate() {
                const dateElement = document.getElementById('current-date');
                if (dateElement) {
                    dateElement.textContent = new Date().toLocaleDateString();
                }
            }

            hideLoadingScreen() {
                const loadingScreen = document.getElementById('loading-screen');
                const app = document.getElementById('app');
                
                if (loadingScreen) loadingScreen.classList.add('hidden');
                if (app) app.classList.remove('hidden');
            }

            async handleCheckStatus() {
                const workerInput = document.getElementById('worker-id-input');
                const workerId = workerInput?.value?.trim();

                if (!workerId || workerId.length < 7) {
                    this.showToast('Please enter a valid Worker ID (7+ digits)', 'error');
                    return;
                }

                this.currentWorkerId = workerId;
                
                try {
                    await this.loadSchedules();
                    this.showSchedules();
                    this.showToast(`Welcome Worker ${workerId}!`, 'success');
                } catch (error) {
                    this.showToast('Error loading schedules: ' + error.message, 'error');
                }
            }

            async loadSchedules() {
                try {
                    const response = await API.getAvailableSchedules();
                    if (response.success) {
                        this.schedules = response.data.schedules || [];
                    } else {
                        throw new Error(response.message || 'Failed to load schedules');
                    }
                } catch (error) {
                    throw new Error(`Failed to load schedules: ${error.message}`);
                }
            }

            showSchedules() {
                const section = document.getElementById('schedules-section');
                const container = document.getElementById('schedules-container');
                
                if (!section || !container) return;

                section.classList.remove('hidden');
                container.innerHTML = '';

                if (this.schedules.length === 0) {
                    container.innerHTML = '<p>No schedules available today.</p>';
                    return;
                }

                this.schedules.forEach(schedule => {
                    const scheduleCard = this.createScheduleCard(schedule);
                    container.appendChild(scheduleCard);
                });
            }

            createScheduleCard(schedule) {
                const card = document.createElement('div');
                card.className = 'schedule-card';
                
                card.innerHTML = `
                    <div class="schedule-header">
                        <h3>${schedule.name}</h3>
                    </div>
                    <div class="schedule-details">
                        <p><strong>Time:</strong> ${schedule.departure_time} - ${schedule.arrival_time}</p>
                        <p><strong>Route:</strong> ${schedule.route}</p>
                        <p><strong>Available:</strong> ${schedule.available_seats}/${schedule.capacity} seats</p>
                    </div>
                    <div class="schedule-actions">
                        <button class="btn btn-primary" onclick="app.bookSlot(${schedule.id}, '${schedule.name}')">
                            Book Slot
                        </button>
                    </div>
                `;
                
                return card;
            }

            async bookSlot(scheduleId, scheduleName) {
                if (!this.currentWorkerId) {
                    this.showToast('Please enter your Worker ID first', 'error');
                    return;
                }

                const today = new Date().toISOString().split('T')[0];
                
                try {
                    const response = await API.createBooking(this.currentWorkerId, scheduleId, today);
                    
                    if (response.success) {
                        this.showToast(`Booking confirmed for ${scheduleName}! Booking ID: ${response.data.booking_id}`, 'success');
                        // Refresh schedules to show updated seat count
                        await this.loadSchedules();
                        this.showSchedules();
                    } else {
                        throw new Error(response.message || 'Booking failed');
                    }
                } catch (error) {
                    this.showToast('Booking failed: ' + error.message, 'error');
                }
            }

            showToast(message, type = 'info') {
                const container = document.getElementById('toast-container');
                if (!container) return;

                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                
                container.appendChild(toast);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 5000);
            }
        }

        // Initialize app when DOM is ready
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            app = new BusBookingApp();
        });
    </script>

    <!-- Additional styling -->
    <style>
        .offline-indicator {
            font-size: 0.8em;
            color: #ffc107;
            background: rgba(255, 193, 7, 0.1);
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 10px;
        }
        
        .schedule-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .schedule-header h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
        }
        
        .schedule-details p {
            margin: 8px 0;
            color: #555;
        }
        
        .schedule-actions {
            margin-top: 15px;
        }
        
        .toast {
            padding: 12px 20px;
            margin: 10px 0;
            border-radius: 4px;
            color: white;
            font-weight: bold;
        }
        
        .toast-success { background: #28a745; }
        .toast-error { background: #dc3545; }
        .toast-info { background: #17a2b8; }
        
        .hidden { display: none !important; }
        
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>
</html>